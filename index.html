<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="–†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä—à—Ä—É—Ç–æ–≤ –º–µ—Ç—Ä–æ –¥–ª—è –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π">
    <meta name="theme-color" content="#2c3e50">
    <title>–ö–∞—Ä—Ç–∞ –º–µ—Ç—Ä–æ - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MetroMap">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@5.3.0/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@5.3.0/dist/maplibre-gl.js"></script>
    
    <!-- PMTiles -->
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    
    <!-- MapLibre GL Draw (for editing) -->
    <link href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" rel="stylesheet">
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="map"></div>
    
    <!-- Controls Panel -->
    <div id="controls-panel" class="controls-panel">
        <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã –º–µ—Ç—Ä–æ</h3>
        
        <div class="control-group">
            <button id="toggle-edit-mode" class="btn btn-primary">
                <span id="edit-mode-text">–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
            </button>
        </div>
        
        <div class="control-group" id="edit-controls" style="display: none;">
            <button id="toggle-curve-mode" class="btn">
                <span id="curve-mode-text">–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ: –í–ö–õ</span>
                <span id="curve-indicator" style="display: inline; color: #2ecc71; font-weight: bold;"> ‚úì</span>
            </button>
            <button id="draw-line" class="btn">–†–∏—Å–æ–≤–∞—Ç—å –ª–∏–Ω–∏—é</button>
            <button id="draw-polygon" class="btn">–†–∏—Å–æ–≤–∞—Ç—å —Å—Ç–∞–Ω—Ü–∏—é</button>
        </div>
        
        <div class="control-group" style="display: flex; gap: 10px;">
            <button id="export-geojson" class="btn" style="flex: 1;">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button id="import-geojson-btn" class="btn" style="flex: 1;">–ò–º–ø–æ—Ä—Ç</button>
            <input type="file" id="import-file" accept=".geojson,.json" style="display: none;">
        </div>
        
        <div class="control-group">
            <button id="clear-all-routes" class="btn btn-danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã</button>
        </div>
    </div>
    
    <!-- Show Panel Button (visible when panel is collapsed) -->
    <button id="show-panel" class="show-panel-btn" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M3 8h18M8 3v18" stroke="currentColor" stroke-width="2"/>
            <circle cx="12" cy="12" r="2" fill="#e74c3c"/>
            <circle cx="16" cy="16" r="1.5" fill="#3498db"/>
        </svg>
    </button>
    
    <!-- Show Properties Panel Button (visible when properties panel is collapsed) -->
    <button id="show-properties" class="show-properties-btn" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12 Q8 4, 12 12 T21 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-dasharray="1 3" fill="none"/>
            <circle cx="3" cy="12" r="2" fill="#2ecc71"/>
            <circle cx="21" cy="12" r="2" fill="#e74c3c"/>
        </svg>
    </button>
    
    <!-- Properties Panel (shown when drawing) -->
    <div id="properties-panel" class="properties-panel" style="display: none;">
        <h3>–°–≤–æ–π—Å—Ç–≤–∞ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
        
        <div class="form-group">
            <label for="line-name">–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏:</label>
            <input type="text" id="line-name" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, –õ–∏–Ω–∏—è 1">
        </div>
        
        <div class="form-group">
            <label for="line-color">–¶–≤–µ—Ç:</label>
            <input type="color" id="line-color" value="#ff0000">
        </div>
        
        <div class="form-group">
            <label for="line-width">–®–∏—Ä–∏–Ω–∞: <span id="width-value">6</span>–ø–∫—Å</label>
            <input type="range" id="line-width" min="1" max="20" value="6">
        </div>
        
        <div class="form-group">
            <label for="line-opacity">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span id="opacity-value">1.0</span></label>
            <input type="range" id="line-opacity" min="0" max="1" step="0.1" value="1">
        </div>
        
        <div class="form-group">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="description" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞..." rows="3"></textarea>
        </div>
        
        <div class="button-group">
            <button id="save-properties" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="cancel-properties" class="btn">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
    </div>
    
    <!-- PWA Install Banner -->
    <div id="install-banner" class="install-banner" style="display: none;">
        <div class="install-content">
            <span class="install-icon">üì±</span>
            <div class="install-text">
                <strong>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É –º–µ—Ç—Ä–æ</strong>
                <p>–†–∞–±–æ—Ç–∞–π—Ç–µ –æ—Ñ–ª–∞–π–Ω –≤ –ø–æ–¥–∑–µ–º–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è—Ö</p>
            </div>
            <button id="install-button" class="btn btn-primary">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button id="dismiss-install" class="btn-close">‚úï</button>
        </div>
    </div>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator" style="display: none;">
        <span class="offline-icon">‚ö†Ô∏è</span>
        <span>–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>
    </div>
    
    <script src="app.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        // Register service worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('‚úì Service Worker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                    })
                    .catch((error) => {
                        console.warn('‚úó Service Worker registration failed:', error);
                    });
            });
            
            // Listen for controller change (new SW activated)
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('Service Worker updated, reloading...');
                window.location.reload();
            });
        }
        
        // PWA Install prompt
        let deferredPrompt;
        const installBanner = document.getElementById('install-banner');
        const installButton = document.getElementById('install-button');
        const dismissButton = document.getElementById('dismiss-install');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install banner if not dismissed before
            if (!localStorage.getItem('installDismissed')) {
                installBanner.style.display = 'block';
            }
        });
        
        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                console.log('Install prompt outcome:', outcome);
                installBanner.style.display = 'none';
                deferredPrompt = null;
            });
        }
        
        if (dismissButton) {
            dismissButton.addEventListener('click', () => {
                installBanner.style.display = 'none';
                localStorage.setItem('installDismissed', 'true');
            });
        }
        
        // Offline/Online detection
        const offlineIndicator = document.getElementById('offline-indicator');
        
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineIndicator.style.display = 'none';
            } else {
                offlineIndicator.style.display = 'flex';
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();
        
        // Log app info
        console.log('Metro Map Editor');
        console.log('PWA Enabled:', 'serviceWorker' in navigator);
        console.log('Online:', navigator.onLine);
    </script>
</body>
</html>
